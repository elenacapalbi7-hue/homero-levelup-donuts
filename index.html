<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homero: Pac-Man Real Maze</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #ui { position: absolute; top: 10px; width: 100%; text-align: center; pointer-events: none; z-index: 100; }
        .hud { background: rgba(0,0,0,0.9); padding: 10px; border: 2px solid #ff69b4; border-radius: 12px; display: inline-block; }
    </style>
</head>
<body>

<div id="ui">
    <div class="hud">
        <strong id="lvl-tag">Nivel 3: PAC-MAN</strong><br>
        Donas: <span id="puntos">0</span>/10
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let nivel = 3, puntos = 0, frame = 0, items = [], pellets = [];
// Homero ahora es un cuadrado perfecto basado en el tama√±o de la celda
let jugador = { x: 0, y: 0, w: 0, h: 0, d: 'parado', proximaD: '' };
let enemigos = [];

// EL LABERINTO REAL (Basado en la imagen de Pac-Man cl√°sica)
// 1 = Pared, 0 = Camino con punto, 2 = Espacio vac√≠o/Casa fantasmas
const mapaReal = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
    [1,1,1,1,0,1,1,1,2,1,2,1,1,1,0,1,1,1,1],
    [1,2,2,1,0,1,2,2,2,2,2,2,2,1,0,1,2,2,1],
    [1,1,1,1,0,1,2,1,1,2,1,1,2,1,0,1,1,1,1],
    [1,0,0,0,0,2,2,1,2,2,2,1,2,2,0,0,0,0,1],
    [1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],
    [1,2,2,1,0,1,2,2,2,2,2,2,2,1,0,1,2,2,1],
    [1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
    [1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],
    [1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
    [1,0,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

// DONAS EN POSICIONES FIJAS (Pasillos libres de paredes)
const donasPos = [
    {r:1, c:1}, {r:1, c:17}, {r:3, c:9}, {r:5, c:4}, {r:5, c:14},
    {r:13, c:1}, {r:13, c:17}, {r:15, c:7}, {r:19, c:1}, {r:19, c:17}
];

let TW, TH;

function resize() { 
    canvas.width = window.innerWidth; 
    canvas.height = window.innerHeight;
    TW = canvas.width / 19;
    TH = (canvas.height * 0.9) / 21; // Reservamos espacio para el HUD
    jugador.w = TW * 0.8;
    jugador.h = TW * 0.8; // Cuadrado perfecto
}
window.addEventListener('resize', resize); resize();

// --- CONTROLES (SIN ACELERACI√ìN) ---
let tX = 0, tY = 0;
window.addEventListener('touchstart', e => {
    tX = e.touches[0].clientX; tY = e.touches[0].clientY;
});

window.addEventListener('touchmove', e => {
    e.preventDefault();
    let dx = e.touches[0].clientX - tX, dy = e.touches[0].clientY - tY;
    // Solo registramos la intenci√≥n de giro
    if (Math.abs(dx) > Math.abs(dy)) jugador.proximaD = dx > 0 ? 'r' : 'l';
    else jugador.proximaD = dy > 0 ? 'd' : 'u';
}, {passive: false});

// --- L√ìGICA DE COLISI√ìN CON PAREDES ---
function puedeMoverse(nx, ny) {
    let margin = 2;
    let puntosDeColision = [
        {x: nx + margin, y: ny + margin},
        {x: nx + jugador.w - margin, y: ny + margin},
        {x: nx + margin, y: ny + jugador.h - margin},
        {x: nx + jugador.w - margin, y: ny + jugador.h - margin}
    ];
    return puntosDeColision.every(p => {
        let gx = Math.floor(p.x / TW);
        let gy = Math.floor(p.y / TH);
        return mapaReal[gy] && mapaReal[gy][gx] !== 1;
    });
}

function motorPacman() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
    
    // 1. Dibujar Laberinto (Paredes Azules de la imagen)
    mapaReal.forEach((fila, r) => {
        fila.forEach((celda, c) => {
            if(celda === 1) {
                ctx.strokeStyle = "#2424ff"; ctx.lineWidth = 2;
                ctx.strokeRect(c*TW + 2, r*TH + 2, TW - 4, TH - 4);
            }
        });
    });

    // 2. Dibujar y comer puntitos blancos
    pellets.forEach((p, i) => {
        ctx.fillStyle = "#fff";
        ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
        if(Math.hypot(jugador.x + jugador.w/2 - p.x, jugador.y + jugador.h/2 - p.y) < 10) pellets.splice(i, 1);
    });

    // 3. Movimiento Constante (Sin aceleraci√≥n)
    let vel = 2.5;
    let intentoX = jugador.x, intentoY = jugador.y;
    
    // Intentar girar si el usuario desliz√≥
    if(jugador.proximaD === 'r') { if(puedeMoverse(jugador.x + vel, jugador.y)) jugador.d = 'r'; }
    if(jugador.proximaD === 'l') { if(puedeMoverse(jugador.x - vel, jugador.y)) jugador.d = 'l'; }
    if(jugador.proximaD === 'u') { if(puedeMoverse(jugador.x, jugador.y - vel)) jugador.d = 'u'; }
    if(jugador.proximaD === 'd') { if(puedeMoverse(jugador.x, jugador.y + vel)) jugador.d = 'd'; }

    if(jugador.d === 'r') intentoX += vel;
    if(jugador.d === 'l') intentoX -= vel;
    if(jugador.d === 'u') intentoY -= vel;
    if(jugador.d === 'd') intentoY += vel;

    if(puedeMoverse(intentoX, intentoY)) {
        jugador.x = intentoX; jugador.y = intentoY;
    }

    // 4. Enemigos y Colisi√≥n Real
    const iconos = ["üë¥", "ü§°", "üë©", "üë®‚Äçüîß"];
    enemigos.forEach((e, i) => {
        let a = Math.atan2(jugador.y - e.y, jugador.x - e.x);
        e.x += Math.cos(a)*1.4; e.y += Math.sin(a)*1.4;
        ctx.font = "25px Arial";
        ctx.fillText(iconos[i%4], e.x - 10, e.y + 10);
        // Colisi√≥n solo si el icono toca el cuerpo de Homero
        if(Math.hypot(jugador.x + jugador.w/2 - e.x, jugador.y + jugador.h/2 - e.y) < 20) reiniciar();
    });

    // 5. Donas Fijas (Ubicadas manualmente en caminos)
    items.forEach((it, i) => {
        ctx.font = "20px Arial";
        ctx.fillText("üç©", it.x - 10, it.y + 10);
        if(Math.hypot(jugador.x + jugador.w/2 - it.x, jugador.y + jugador.h/2 - it.y) < 25) {
            items.splice(i, 1); sumarPunto();
        }
    });

    // Dibujar Homero (Cuadrado amarillo perfecto)
    ctx.fillStyle = "yellow";
    ctx.fillRect(jugador.x, jugador.y, jugador.w, jugador.h);
}

// Motores de otros niveles estabilizados (Niveles 1 y 2 con escala fija)
function motorRitmo() {
    ctx.fillStyle = "#1a1a2e"; ctx.fillRect(0,0,canvas.width, canvas.height);
    actualizarFisica(canvas.height-110);
    if(frame % 130 === 0) items.push({x: canvas.width, y: canvas.height-95, t: 'c'});
    if(frame % 170 === 0) items.push({x: canvas.width, y: canvas.height-220, t: 'd'});
    items.forEach((it, i) => {
        it.x -= 6; ctx.font = "40px Arial"; ctx.fillText(it.t === 'c' ? "üåµ" : "üç©", it.x, it.y);
        if (Math.hypot(jugador.x - it.x, jugador.y - it.y) < 45) {
            it.t === 'c' ? reiniciar() : (items.splice(i, 1), sumarPunto());
        }
    });
    dibujarHomeroGeneral();
}

function motorSurvivor() {
    ctx.fillStyle = "#2d3436"; ctx.fillRect(0,0,canvas.width, canvas.height);
    if(frame % 100 === 0) items.push({x: Math.random()*canvas.width, y: -50, t: 'z'});
    if(frame % 150 === 0) items.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, t: 'd'});
    items.forEach((it, i) => {
        if(it.t === 'z') {
            let a = Math.atan2(jugador.y - it.y, jugador.x - it.x);
            it.x += Math.cos(a)*2.5; it.y += Math.sin(a)*2.5; ctx.fillText("üßü", it.x, it.y);
            if(Math.hypot(jugador.x - it.x, jugador.y - it.y) < 30) reiniciar();
        } else {
            ctx.fillText("üç©", it.x, it.y);
            if(Math.hypot(jugador.x - it.x, jugador.y - it.y) < 60) { items.splice(i, 1); sumarPunto(); }
        }
    });
    dibujarHomeroGeneral();
}

// Funciones Core
function actualizarFisica(s) {
    jugador.vy += 0.8; jugador.y += jugador.vy;
    if(jugador.y > s) { jugador.y = s; jugador.vy = 0; jugador.saltos = 0; }
}
function dibujarHomeroGeneral() { ctx.fillStyle = "yellow"; ctx.fillRect(jugador.x, jugador.y, 40, 50); }

function sumarPunto() {
    puntos++; document.getElementById('puntos').innerText = puntos;
    if(puntos >= 10) { 
        nivel++; puntos = 0; items = []; pellets = []; frame = 0; 
        prepararNivel();
        alert("¬°Nivel superado!");
    }
}

function prepararNivel() {
    document.getElementById('lvl-tag').innerText = "Nivel " + nivel;
    if(nivel === 3) {
        jugador.x = TW + 2; jugador.y = TH + 2;
        jugador.d = 'parado'; jugador.proximaD = '';
        enemigos = [{x: 9*TW, y: 10*TH}, {x: 2*TW, y: 19*TH}, {x: 16*TW, y: 19*TH}, {x: 16*TW, y: 1*TH}];
        // Llenar puntitos blancos
        mapaReal.forEach((fila, r) => { fila.forEach((celda, c) => {
            if(celda === 0) pellets.push({x: c*TW + TW/2, y: r*TH + TH/2});
        });});
        // Colocar 10 donas fijas en el centro de las celdas de camino
        donasPos.forEach(p => items.push({x: p.c*TW + TW/2, y: p.r*TH + TH/2}));
    } else {
        jugador.x = 80; jugador.y = canvas.height/2;
    }
}

function reiniciar() { alert("¬°D'oh!"); puntos = 0; items = []; pellets = []; frame = 0; prepararNivel(); }

function loop() {
    ctx.clearRect(0,0,canvas.width, canvas.height); frame++;
    if(nivel===1) motorRitmo(); 
    else if(nivel===2) motorSurvivor(); 
    else if(nivel===3) motorPacman();
    requestAnimationFrame(loop);
}
prepararNivel(); loop();
</script>
</body>
</html>
