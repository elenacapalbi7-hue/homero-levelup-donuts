<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homer Bros 1-1 - Versi√≥n Final Corregida</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: 'Arial Black', sans-serif; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #5c94fc; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        #ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; color: white; text-shadow: 2px 2px #000; z-index: 10; font-size: 16px; }
        #controls { position: absolute; bottom: 90px; width: 100%; display: flex; justify-content: space-between; padding: 0 25px; box-sizing: border-box; z-index: 20; }
        .btn { width: 70px; height: 70px; background: rgba(255,255,255,0.3); border: 3px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; user-select: none; -webkit-tap-highlight-color: transparent; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; color: yellow; z-index: 100; text-align: center; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui">
        <div>HOMERO<br>000000</div>
        <div>üç© x <span id="donas">0</span></div>
        <div>WORLD<br>1-1</div>
        <div>TIME<br><span id="timer">400</span></div>
    </div>
    
    <div id="overlay" onclick="location.reload()">
        <h1 id="msg-title">D'OH!</h1>
        <p>TOCA LA PANTALLA PARA REINTENTAR</p>
    </div>

    <div id="controls">
        <div style="display:flex; gap:20px;">
            <div class="btn" id="left">‚¨ÖÔ∏è</div>
            <div class="btn" id="right">‚û°Ô∏è</div>
        </div>
        <div class="btn" id="jump">‚¨ÜÔ∏è</div>
    </div>
    <canvas id="canvas"></canvas>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const GRID = 40;

let camX = 0, coins = 0, timeLeft = 400, active = true, frameCount = 0;
let blocks = [], enemies = [], items = [], particles = [];
let keys = { left: false, right: false };

const p = { x: 80, y: 0, w: 32, h: 42, vx: 0, vy: 0, ground: false, isSuper: false };

function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const gY = canvas.height - 80;
    
    // 1. GENERAR SUELO CONTINUO (Sin huecos aburridos al inicio)
    for(let i=0; i<300; i++) {
        if(!([70, 71, 86, 87, 88, 155, 156].includes(i))) {
            blocks.push({x: i*GRID, y: gY, w: GRID, h: GRID, t: 'G'});
        }
    }

    // 2. MAPA REPLETO (Basado en el video original)
    const mapData = [
        [16, 9, '?', 'dona'], [20, 9, 'B'], [21, 9, '?', 'beer'], [22, 9, 'B'], [23, 9, '?', 'dona'], [22, 5, '?', 'dona'],
        [28, 12, 'P', 2], [38, 12, 'P', 3], [46, 12, 'P', 4], [57, 12, 'P', 4],
        [78, 9, '?', 'beer'], [80, 5, 'B'], [81, 5, 'B'], [82, 5, 'B'], [83, 5, 'B'],
        [91, 5, 'B'], [92, 5, 'B'], [93, 5, 'B'], [94, 9, 'B'],
        [100, 9, 'B', 'multi'], [106, 9, 'B'], [107, 9, '?', 'dona'], [108, 9, '?', 'dona'], [109, 9, 'B'],
        [120, 9, 'B'], [121, 9, 'B'], [122, 9, 'B'],
        // Escalera Final
        [145, 12, 'S', 1], [146, 12, 'S', 2], [147, 12, 'S', 3], [148, 12, 'S', 4],
        [152, 12, 'S', 4], [153, 12, 'S', 3], [154, 12, 'S', 2], [155, 12, 'S', 1],
        [180, 12, 'CASA']
    ];

    mapData.forEach(m => {
        let bx = m[0] * GRID;
        if(m[2] === 'P') { for(let h=0; h<m[3]; h++) blocks.push({x: bx, y: gY-((h+1)*GRID), w: GRID*2, h: GRID, t: 'P'}); }
        else if(m[2] === 'S') { for(let h=0; h<m[3]; h++) blocks.push({x: bx, y: gY-((h+1)*GRID), w: GRID, h: GRID, t: 'S'}); }
        else if(m[2] === 'CASA') { blocks.push({x: bx, y: gY-160, w: 160, h: 160, t: 'CASA'}); }
        else { blocks.push({x: bx, y: gY-((13-m[1])*GRID), w: GRID, h: GRID, t: m[2], item: m[3], hits: m[3]==='multi'?8:1}); }
    });

    // 3. ENEMIGOS EN POSICIONES CLAVE
    [22, 40, 52, 82, 95, 110, 125, 138].forEach(ex => enemies.push({x: ex*GRID, y: gY-40, vx: -1.8}));

    p.y = gY - 100;
    loop();
}

function update() {
    if(!active) return;
    if (keys.left) p.vx = -4.5; else if (keys.right) p.vx = 4.5; else p.vx *= 0.8;
    p.vy += 0.9; p.x += p.vx; p.y += p.vy;
    if(p.x > camX + 250) camX = p.x - 250;

    p.ground = false;
    blocks.forEach(b => {
        if (p.x + p.w > b.x && p.x < b.x + b.w && p.y + p.h > b.y && p.y < b.y + b.h) {
            if(b.t === 'CASA') { active=false; document.getElementById('overlay').style.display="flex"; document.getElementById('msg-title').innerText="¬°HOGAR, DULCE HOGAR!"; return; }
            
            // Colisi√≥n desde arriba (Suelo)
            if (p.vy > 0 && p.y + p.h - p.vy <= b.y) { p.y = b.y - p.h; p.vy = 0; p.ground = true; }
            // Colisi√≥n desde abajo (Golpear bloque)
            else if (p.vy < 0 && p.y - p.vy >= b.y + b.h) {
                p.y = b.y + b.h; p.vy = 2;
                if((b.t === '?' || b.t === 'B') && b.t !== 'U') {
                    if(b.item === 'beer') items.push({x: b.x, y: b.y-40, t:'üç∫', vy:-5});
                    if(b.item === 'dona' || b.item === 'multi') { 
                        coins++; document.getElementById('donas').innerText = coins;
                        particles.push({x: b.x, y: b.y-40, life: 30}); // Efecto visual de la dona saliendo
                    }
                    if(b.hits > 1) b.hits--; else b.t = 'U';
                }
            } 
            // Colisi√≥n lateral
            else { if(p.vx > 0) p.x = b.x - p.w; else if(p.vx < 0) p.x = b.x + b.w; }
        }
    });

    items.forEach((it, i) => {
        it.y += it.vy || 0;
        if(it.vy < 0) it.vy += 0.5; else it.vy = 0; // Brota y se queda quieto
        if(Math.abs(p.x-it.x)<35 && Math.abs(p.y-it.y)<40) {
            if(it.t==='üç∫') { p.isSuper=true; p.h=65; p.y-=20; }
            items.splice(i,1);
        }
    });

    enemies.forEach((en, i) => {
        en.x += en.vx;
        if(Math.abs(p.x - en.x) < 30 && Math.abs(p.y - en.y) < 35) {
            if(p.vy > 0) { enemies.splice(i,1); p.vy = -10; } else reset();
        }
    });

    if(p.y > canvas.height) reset();
    if(frameCount % 60 === 0) { timeLeft--; document.getElementById('timer').innerText = timeLeft; if(timeLeft<=0) reset(); }
}

function reset() { active=false; document.getElementById('overlay').style.display="flex"; }

function draw() {
    ctx.clearRect(0,0, canvas.width, canvas.height);
    ctx.save(); ctx.translate(-camX, 0);

    blocks.forEach(b => {
        if(b.t === 'CASA') { 
            ctx.font="140px Arial"; ctx.fillText("üè†", b.x, b.y+120); 
            ctx.font="40px Arial"; ctx.fillText("üë©‚Äçüëß‚Äçüë¶", b.x+40, b.y+160); 
        } else {
            ctx.fillStyle = b.t==='G'?'#944828': b.t==='P'?'#27ae60': b.t==='B'?'#e76e33': b.t==='?'?'#f1c40f': '#7f8c8d';
            ctx.fillRect(b.x, b.y, b.w, b.h);
            ctx.strokeStyle="#000"; ctx.strokeRect(b.x, b.y, b.w, b.h);
            if(b.t==='?') { ctx.fillStyle="#fff"; ctx.font="20px Arial"; ctx.fillText("?", b.x+14, b.y+26); }
        }
    });

    particles.forEach((pa, i) => { pa.y -= 2; pa.life--; ctx.font="25px Arial"; ctx.fillText("üç©", pa.x+5, pa.y); if(pa.life<=0) particles.splice(i,1); });
    items.forEach(it => { ctx.font="30px Arial"; ctx.fillText(it.t, it.x+5, it.y+30); });
    enemies.forEach(en => { ctx.font="35px Arial"; ctx.fillText("üë®‚Äçüè´", en.x, en.y+35); });
    
    ctx.font = p.h + "px Arial";
    ctx.fillText("üë®‚Äçü¶≤", p.x, p.y + p.h);
    ctx.restore();
}

function loop() { frameCount++; update(); draw(); if(active) requestAnimationFrame(loop); }

const ctrl = (id, k) => {
    const el = document.getElementById(id);
    el.ontouchstart = (e) => { e.preventDefault(); if(k==='j') { if(p.ground) p.vy=-17; } else keys[k]=true; };
    el.ontouchend = () => { if(k!=='j') keys[k]=false; };
};
ctrl('left', 'left'); ctrl('right', 'right'); ctrl('jump', 'j');
window.onload = init;
</script>
</body>
</html>
