<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homer Super World</title>
    <style>
        body { margin: 0; background: #5c94fc; overflow: hidden; touch-action: none; font-family: 'Arial', sans-serif; }
        #ui { position: absolute; top: 0; width: 100%; z-index: 10; pointer-events: none; color: white; text-shadow: 2px 2px #000; }
        .hud { display: flex; justify-content: space-around; padding: 10px; font-size: 1.2rem; }
        #controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; }
        .btn { width: 80px; height: 80px; background: rgba(0,0,0,0.4); border: 3px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 35px; pointer-events: auto; color: white; }
        .d-pad { display: flex; gap: 15px; }
    </style>
</head>
<body>

<div id="ui">
    <div class="hud">
        <div>HOMERO<br><span id="puntos">000000</span></div>
        <div>DONAS<br>üç© x <span id="donasCount">0</span></div>
        <div>ESTADO<br><span id="estado">NORMAL</span></div>
    </div>
</div>

<div id="controls">
    <div class="d-pad">
        <div class="btn" id="btnLeft">‚¨ÖÔ∏è</div>
        <div class="btn" id="btnRight">‚û°Ô∏è</div>
    </div>
    <div class="btn" id="btnJump">‚¨ÜÔ∏è</div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const GRAVEDAD = 0.8;
const VEL_MAX = 5.5;
const SALTO_FUERZA = -15;

let puntos = 0, donas = 0, frame = 0, camX = 0;
let bloques = [], enemigos = [], items = [];
let keys = { left: false, right: false };

let h = { 
    x: 100, y: 0, w: 40, h: 70, 
    vx: 0, vy: 0, 
    saltos: 2, 
    grande: false,
    timerGrande: 0
};

// --- MAPA Y ESTRUCTURA ---
function crearNivel() {
    bloques = []; enemigos = []; items = [];
    const hPantalla = canvas.height;

    for(let i=0; i<400; i++) {
        // Suelo base (doble fila)
        if (!(i > 80 && i < 85) && !(i > 160 && i < 165)) {
            bloques.push({x: i*40, y: hPantalla-40, t:'S'});
            bloques.push({x: i*40, y: hPantalla-80, t:'S'});
        }

        // Estructura de "Fila y arriba otra fila" (Mec√°nica Mario)
        if (i >= 20 && i <= 30) {
            bloques.push({x: i*40, y: hPantalla-200, t:'L'}); // Fila inferior
            if (i >= 22 && i <= 28) bloques.push({x: i*40, y: hPantalla-320, t:'L'}); // Fila superior
        }

        // Bloques Especiales
        if(i === 21) bloques.push({x: i*40, y: hPantalla-200, t:'?', contenido:'Duff'}); 
        if(i === 25) bloques.push({x: i*40, y: hPantalla-320, t:'?', contenido:'DonaMulti', usos: 5});
        
        // Escaleras de bloques
        if(i >= 50 && i <= 55) {
            for(let j=0; j<(i-50); j++) {
                bloques.push({x: i*40, y: hPantalla-120-(j*40), t:'L'});
            }
        }
    }
}

function spawnItem(x, y, tipo) {
    items.push({ x: x, y: y, vx: 2, vy: -5, t: tipo, activo: true });
}

function update() {
    if (keys.left) h.vx = -VEL_MAX;
    else if (keys.right) h.vx = VEL_MAX;
    else h.vx = 0;

    h.vy += GRAVEDAD;
    h.x += h.vx;
    h.y += h.vy;

    if (h.x > camX + canvas.width/2) camX = h.x - canvas.width/2;

    if (h.timerGrande > 0) {
        h.timerGrande--;
        if (h.timerGrande === 0) h.grande = false;
    }

    // Colisiones Bloques
    bloques.forEach((b, idx) => {
        if (h.x + h.w > b.x && h.x < b.x + 40 && h.y + h.h > b.y && h.y < b.y + 40) {
            // Suelo
            if (h.vy > 0 && h.y + h.h - h.vy <= b.y) {
                h.y = b.y - h.h; h.vy = 0; h.saltos = 2;
            }
            // Techo (Golpe de cabeza)
            else if (h.vy < 0 && h.y - h.vy >= b.y + 40) {
                h.y = b.y + 40; h.vy = 2;
                if (b.t === '?' || b.t === 'L') {
                    if (b.contenido === 'Duff') {
                        spawnItem(b.x, b.y - 40, 'üç∫');
                        b.contenido = null; b.t = 'U';
                    } else if (b.contenido === 'DonaMulti') {
                        donas++; puntos += 100; b.usos--;
                        if (b.usos <= 0) { b.t = 'U'; b.contenido = null; }
                    } else if (b.t === 'L' && h.grande) {
                        bloques.splice(idx, 1); puntos += 50;
                    }
                }
            }
        }
    });

    // Items (F√≠sica del superpoder movi√©ndose)
    items.forEach((it, idx) => {
        it.vy += 0.5; it.x += it.vx; it.y += it.vy;
        // Colisi√≥n √≠tem con suelo
        bloques.forEach(b => {
            if(it.x < b.x + 40 && it.x + 30 > b.x && it.y + 30 > b.y && it.y < b.y + 40) {
                it.vy = 0; it.y = b.y - 30;
            }
        });
        // Homero agarra √≠tem
        if (h.x + h.w > it.x && h.x < it.x + 30 && h.y + h.h > it.y && h.y < it.y + 30) {
            if(it.t === 'üç∫') { h.grande = true; h.timerGrande = 600; }
            items.splice(idx, 1);
        }
    });

    if (h.y > canvas.height) { h.x = 100; h.y = 0; camX = 0; }
}

function draw() {
    ctx.clearRect(0,0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camX, 0);

    // Dibujar Bloques
    bloques.forEach(b => {
        ctx.fillStyle = (b.t==='S' || b.t==='L') ? "#e76e33" : (b.t==='U' ? "#7f8c8d" : "#f1c40f");
        ctx.fillRect(b.x, b.y, 40, 40);
        ctx.strokeStyle = "black"; ctx.strokeRect(b.x, b.y, 40, 40);
        if(b.t === '?') { ctx.fillStyle="white"; ctx.font="20px Arial"; ctx.fillText("?", b.x+15, b.y+25); }
    });

    // Dibujar Items (Superpoder)
    items.forEach(it => { ctx.font = "30px Arial"; ctx.fillText(it.t, it.x, it.y + 25); });

    // Homero Completo
    ctx.font = h.grande ? "90px Arial" : "65px Arial";
    let walk = (keys.left || keys.right) ? Math.sin(frame*0.2)*5 : 0;
    ctx.fillText("üë®‚Äçü¶≤", h.x - 10, h.y + (h.grande ? 85 : 65) + walk);
    ctx.font = h.grande ? "70px Arial" : "50px Arial";
    ctx.fillText("üëï", h.x - 5, h.y + (h.grande ? 130 : 100) + walk);
    ctx.fillText("üëñ", h.x - 5, h.y + (h.grande ? 170 : 135) + walk);

    // FINAL: Casa y Familia
    const fX = 14000;
    ctx.font = "120px Arial"; ctx.fillText("üè†", fX, canvas.height-180);
    ctx.font = "60px Arial";
    ctx.fillText("üë©‚Äçü¶±", fX - 60, canvas.height-120); // Marge
    ctx.fillText("üë¶", fX + 120, canvas.height-120); // Bart
    ctx.fillText("üëß", fX + 180, canvas.height-120); // Lisa
    ctx.fillText("üë∂", fX + 230, canvas.height-120); // Maggie

    if(h.x > fX + 50) { alert("¬°Nivel Ganado! Homero lleg√≥ a casa."); h.x = 100; camX = 0; }

    ctx.restore();
    document.getElementById('donasCount').innerText = donas;
    document.getElementById('puntos').innerText = String(puntos).padStart(6, '0');
    document.getElementById('estado').innerText = h.grande ? "¬°SUPER!" : "NORMAL";
}

// --- CONTROLES ---
const setup = () => {
    const bL = document.getElementById('btnLeft');
    const bR = document.getElementById('btnRight');
    const bJ = document.getElementById('btnJump');
    bL.ontouchstart = () => keys.left = true; bL.ontouchend = () => keys.left = false;
    bR.ontouchstart = () => keys.right = true; bR.ontouchend = () => keys.right = false;
    bJ.ontouchstart = () => { if(h.saltos > 0) { h.vy = SALTO_FUERZA; h.saltos--; } };
};

function loop() { frame++; update(); draw(); requestAnimationFrame(loop); }
window.onload = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; setup(); crearNivel(); loop(); };
</script>
</body>
</html>
