<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homer Adventure 1-1 Fixed</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: 'Arial', sans-serif; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #5c94fc; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        
        #ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; color: white; text-shadow: 2px 2px #000; font-size: 14px; z-index: 10; pointer-events: none; }
        
        /* Controles elevados para evitar gestos de Android/iOS */
        #controls { position: absolute; bottom: 85px; width: 100%; display: flex; justify-content: space-between; padding: 0 25px; box-sizing: border-box; z-index: 20; }
        .btn { width: 65px; height: 65px; background: rgba(255, 255, 255, 0.25); border: 2px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; user-select: none; }
        
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; color: yellow; z-index: 100; text-align: center; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui">
        <div>HOMERO<br>000000</div>
        <div>üç©<br>x <span id="donas">00</span></div>
        <div>WORLD<br>1-1</div>
        <div>TIME<br><span id="timer">400</span></div>
    </div>
    
    <div id="overlay">
        <h1 id="msg-title">D'OH!</h1>
        <p>TOCA AQU√ç PARA REINTENTAR</p>
    </div>

    <div id="controls">
        <div style="display:flex; gap:20px;">
            <div class="btn" id="left">‚¨ÖÔ∏è</div>
            <div class="btn" id="right">‚û°Ô∏è</div>
        </div>
        <div class="btn" id="jump">JUMP</div>
    </div>
    <canvas id="canvas"></canvas>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const GRID = 40;

let camX = 0, coins = 0, timeLeft = 400, active = true, frameCount = 0;
let blocks = [], enemies = [], items = [];
let keys = { left: false, right: false };

const p = { x: 100, y: 0, w: 32, h: 45, vx: 0, vy: 0, ground: false };

function buildMap() {
    blocks = []; enemies = []; items = [];
    const gY = canvas.height - 80;
    p.y = gY - 100;

    // 1. Suelo original con sus 3 huecos exactos
    for(let i=0; i<220; i++) {
        if(!([69, 70, 86, 87, 88, 153, 154].includes(i))) {
            blocks.push({x: i*GRID, y: gY, w: GRID, h: GRID, t: 'G'});
        }
    }

    // 2. Elementos del nivel (R√©plica 1-1)
    const levelItems = [
        // Bloques interrogaci√≥n y Ladrillos iniciales
        [16, 9, '?'], [20, 9, 'B'], [21, 9, '?'], [22, 9, 'B'], [23, 9, '?'], [22, 5, '?'],
        // Tuber√≠as
        [28, 12, 'P', 2], [38, 12, 'P', 3], [46, 12, 'P', 4], [57, 12, 'P', 4],
        // Bloques despu√©s de tuber√≠as
        [77, 9, 'B'], [78, 9, '?'], [79, 9, 'B'],
        // Escalera final
        [134, 12, 'S', 1], [135, 12, 'S', 2], [136, 12, 'S', 3], [137, 12, 'S', 4],
        [140, 12, 'S', 4], [141, 12, 'S', 3], [142, 12, 'S', 2], [143, 12, 'S', 1],
        // M√°stil
        [160, 12, 'FLAG']
    ];

    levelItems.forEach(m => {
        let bx = m[0] * GRID;
        if(m[2] === 'P') { // Tuber√≠as
            for(let h=0; h<m[3]; h++) blocks.push({x: bx, y: gY - ((h+1)*GRID), w: GRID*2, h: GRID, t: 'P'});
        } else if(m[2] === 'S') { // Escaleras
            for(let h=0; h<m[3]; h++) blocks.push({x: bx, y: gY - ((h+1)*GRID), w: GRID, h: GRID, t: 'S'});
        } else if(m[2] === 'FLAG') { // Bandera
            blocks.push({x: bx, y: gY - (GRID*8), w: 10, h: GRID*8, t: 'FLAG'});
        } else { // Bloques
            let by = gY - ((13 - m[1]) * GRID);
            blocks.push({x: bx, y: by, w: GRID, h: GRID, t: m[2]});
        }
    });

    // 3. Enemigos (Flanders)
    [22, 40, 51, 80, 97, 114].forEach(ex => {
        enemies.push({x: ex*GRID, y: gY - GRID, vx: -1.5, w: 35, h: 35});
    });
}

function update() {
    if(!active) return;

    // Movimiento
    if (keys.left) p.vx = -4.5;
    else if (keys.right) p.vx = 4.5;
    else p.vx *= 0.8;

    p.vy += 0.8;
    p.x += p.vx;
    p.y += p.vy;

    // C√°mara
    if(p.x > camX + (canvas.width/3)) camX = p.x - (canvas.width/3);
    if(camX < 0) camX = 0;

    // Colisiones
    p.ground = false;
    blocks.forEach(b => {
        if (p.x + p.w > b.x && p.x < b.x + b.w && p.y + p.h > b.y && p.y < b.y + b.h) {
            if(b.t === 'FLAG') { active = false; document.getElementById('overlay').style.display="flex"; document.getElementById('msg-title').innerText="¬°EXCELENTE!"; }
            if (p.vy > 0 && p.y + p.h - p.vy <= b.y) {
                p.y = b.y - p.h; p.vy = 0; p.ground = true;
            } else if (p.vx > 0 && p.x < b.x) p.x = b.x - p.w;
            else if (p.vx < 0 && p.x > b.x) p.x = b.x + b.w;
        }
    });

    // Muerte por ca√≠da o Flanders
    if(p.y > canvas.height) resetGame();
    enemies.forEach((en, i) => {
        en.x += en.vx;
        if(Math.abs(p.x - en.x) < 30 && Math.abs(p.y - en.y) < 30) {
            if(p.vy > 0) { enemies.splice(i, 1); p.vy = -10; }
            else resetGame();
        }
    });

    frameCount++;
    if(frameCount % 60 === 0) {
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft;
    }
}

function resetGame() {
    active = false;
    document.getElementById('overlay').style.display = "flex";
}

function draw() {
    ctx.clearRect(0,0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camX, 0);

    blocks.forEach(b => {
        if(b.t==='G') ctx.fillStyle = '#944828';
        else if(b.t==='P') ctx.fillStyle = '#27ae60';
        else if(b.t==='B') ctx.fillStyle = '#e76e33';
        else if(b.t==='S') ctx.fillStyle = '#bdc3c7';
        else if(b.t==='FLAG') ctx.fillStyle = '#fff';
        else ctx.fillStyle = '#f1c40f';
        ctx.fillRect(b.x, b.y, b.w, b.h);
        ctx.strokeRect(b.x, b.y, b.w, b.h);
    });

    enemies.forEach(en => { ctx.font = "30px Arial"; ctx.fillText("üë®‚Äçüè´", en.x, en.y + 30); });

    // Homero
    ctx.font = "40px Arial";
    ctx.fillText("üë®‚Äçü¶≤", p.x, p.y + p.h);

    ctx.restore();
}

function loop() {
    update();
    draw();
    if(active) requestAnimationFrame(loop);
}

// Controles
const setupControl = (id, key) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if(key === 'j') { if(p.ground) p.vy = -16; }
        else keys[key] = true;
    });
    el.addEventListener('touchend', () => { if(key !== 'j') keys[key] = false; });
};

setupControl('left', 'left');
setupControl('right', 'right');
setupControl('jump', 'j');

document.getElementById('overlay').addEventListener('click', () => location.reload());

// Iniciar al cargar
window.onload = () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    buildMap();
    loop();
};
</script>
</body>
</html>
