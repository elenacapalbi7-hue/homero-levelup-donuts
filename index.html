<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homero: Springfield Quest</title>
    <style>
        body { margin: 0; background: #4da6ff; color: #fff; font-family: sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #ui { position: absolute; top: 10px; width: 100%; text-align: center; pointer-events: none; z-index: 100; }
        .hud { background: rgba(0,0,0,0.8); padding: 10px; border: 3px solid #ff69b4; border-radius: 15px; display: inline-block; pointer-events: auto; }
    </style>
</head>
<body>

<div id="ui">
    <div class="hud" onclick="saltarNivel()">
        <strong id="lvl-tag">Nivel 1</strong><br>
        Donas: <span id="puntos">0</span>/10
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let nivel = 1, puntos = 0, frame = 0, items = [], enemigos = [];
let camX = 0;

let jugador = { 
    x: 50, y: 0, w: 40, h: 50, 
    vy: 0, saltos: 0, dir: 0, 
    velocidad: 5
};

function resize() { 
    canvas.width = window.innerWidth; 
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize); resize();

// CONTROLES
let tX = 0;
window.addEventListener('touchstart', e => {
    tX = e.touches[0].clientX;
    if (jugador.saltos < 2) { jugador.vy = -12; jugador.saltos++; }
});

window.addEventListener('touchmove', e => {
    e.preventDefault();
    let dx = e.touches[0].clientX - tX;
    if (dx > 20) jugador.dir = 1;
    else if (dx < -20) jugador.dir = -1;
    else jugador.dir = 0;
}, {passive: false});

window.addEventListener('touchend', () => { jugador.dir = 0; });

function saltarNivel() { nivel++; puntos = 0; prepararNivel(); }

function prepararNivel() {
    frame = 0; camX = 0; items = []; enemigos = [];
    jugador.vy = 0; jugador.saltos = 0;
    document.getElementById('lvl-tag').innerText = "Nivel " + nivel;
    document.getElementById('puntos').innerText = puntos;

    if(nivel === 1) { // Lluvia de Donas
        jugador.x = canvas.width/2; 
    } else if(nivel === 2 || nivel === 3) { // Colecci√≥n Simple
        jugador.x = canvas.width/2;
        for(let i=0; i<10; i++) {
            items.push({x: Math.random()*(canvas.width-50), y: Math.random()*(canvas.height-150), t:'d'});
        }
    } else if(nivel === 4) { // MODO MARIO
        jugador.x = 100;
        for(let i=0; i<20; i++) {
            items.push({x: 500 + i*300, y: canvas.height - 150 - (Math.random()*100), t:'d'});
        }
        for(let i=0; i<8; i++) {
            enemigos.push({x: 900 + i*600, y: canvas.height - 110});
        }
    }
}

function sumarPunto() {
    puntos++;
    document.getElementById('puntos').innerText = puntos;
    if(nivel < 4 && puntos >= 10) {
        alert("¬°Siguiente Nivel!");
        nivel++; puntos = 0;
        prepararNivel();
    }
}

function motorNivelesBasicos() {
    ctx.fillStyle = nivel === 1 ? "#1a1a2e" : (nivel === 2 ? "#2d142c" : "#0f3443");
    ctx.fillRect(0,0,canvas.width, canvas.height);
    
    // Movimiento
    jugador.x += jugador.dir * jugador.velocidad;
    if(nivel === 1) {
        if(frame % 40 === 0) items.push({x: Math.random()*canvas.width, y: -50, t:'d'});
    }

    items.forEach((it, i) => {
        if(nivel === 1) it.y += 4;
        ctx.font = "30px Arial"; ctx.fillText("üç©", it.x, it.y);
        if(Math.hypot(jugador.x - it.x, jugador.y - it.y) < 40) { items.splice(i,1); sumarPunto(); }
    });

    jugador.y = canvas.height - 120;
    ctx.fillStyle = "yellow"; ctx.fillRect(jugador.x, jugador.y, 40, 50);
}

function motorNivel4() {
    ctx.fillStyle = "#4da6ff"; ctx.fillRect(0,0,canvas.width, canvas.height);
    
    // Suelo
    ctx.fillStyle = "#8B4513"; ctx.fillRect(0, canvas.height-50, canvas.width, 50);
    ctx.fillStyle = "#228B22"; ctx.fillRect(0, canvas.height-65, canvas.width, 15);

    jugador.x += jugador.dir * 6;
    jugador.vy += 0.6; jugador.y += jugador.vy;
    if(jugador.y > canvas.height - 115) { jugador.y = canvas.height - 115; jugador.vy = 0; jugador.saltos = 0; }

    camX = jugador.x - 100;
    ctx.save();
    ctx.translate(-camX, 0);

    items.forEach((it, i) => {
        ctx.font = "30px Arial"; ctx.fillText("üç©", it.x, it.y);
        if(Math.hypot(jugador.x - it.x, jugador.y - it.y) < 40) { items.splice(i,1); sumarPunto(); }
    });

    enemigos.forEach(e => {
        ctx.font = "40px Arial"; ctx.fillText("üë®‚Äçüè´", e.x, e.y);
        if(Math.hypot(jugador.x - e.x, jugador.y - e.y) < 40) { alert("¬°D'oh! Flanders te atrap√≥"); prepararNivel(); }
    });

    // Casa de los Simpson
    let metaX = 6000;
    ctx.fillStyle = "#ffcccc"; ctx.fillRect(metaX, canvas.height-265, 250, 200);
    ctx.font = "40px Arial"; 
    ctx.fillText("üë©‚Äçü¶±", metaX+60, canvas.height-70); // Marge
    ctx.fillText("üßí", metaX+110, canvas.height-70); // Bart
    ctx.fillText("üëß", metaX+160, canvas.height-70); // Lisa

    if(jugador.x > metaX + 50) {
        alert("¬°Llegaste a casa con tu familia!");
        nivel = 1; puntos = 0; prepararNivel();
    }

    ctx.restore();
    ctx.fillStyle = "yellow"; ctx.fillRect(100, jugador.y, 40, 50);
}

function loop() {
    frame++;
    if(nivel < 4) motorNivelesBasicos();
    else motorNivel4();
    requestAnimationFrame(loop);
}

prepararNivel();
loop();
</script>
</body>
</html>
