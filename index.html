<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homero: Springfield Quest</title>
    <style>
        body { margin: 0; background: #4da6ff; color: #fff; font-family: sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #ui { position: absolute; top: 10px; width: 100%; text-align: center; pointer-events: none; z-index: 100; }
        .hud { background: rgba(0,0,0,0.8); padding: 10px; border: 3px solid #ff69b4; border-radius: 15px; display: inline-block; }
    </style>
</head>
<body>

<div id="ui">
    <div class="hud">
        <strong id="lvl-tag">Nivel 1</strong><br>
        Donas: <span id="puntos">0</span>
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let nivel = 1, puntos = 0, frame = 0, items = [], enemigos = [];
let camX = 0; // C√°mara para el nivel 4

// Homero con f√≠sicas de salto
let jugador = { 
    x: 50, y: 0, w: 40, h: 55, 
    vy: 0, saltos: 0, 
    dir: 0, // -1 izquierda, 0 parado, 1 derecha
    enSuelo: false 
};

// Mapa Nivel 3 (Pacman)
const mapaReal = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

function resize() { 
    canvas.width = window.innerWidth; 
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize); resize();

// CONTROLES
let tX = 0, tY = 0;
window.addEventListener('touchstart', e => {
    tX = e.touches[0].clientX; tY = e.touches[0].clientY;
    // Salto
    if (jugador.saltos < 2) { 
        jugador.vy = -12; 
        jugador.saltos++; 
    }
});

window.addEventListener('touchmove', e => {
    e.preventDefault();
    let dx = e.touches[0].clientX - tX;
    // Movimiento lateral fijo
    if (dx > 20) jugador.dir = 1;
    else if (dx < -20) jugador.dir = -1;
    else jugador.dir = 0;
}, {passive: false});

window.addEventListener('touchend', () => { jugador.dir = 0; });

function reiniciar() {
    alert("¬°D'oh!");
    puntos = 0;
    prepararNivel();
}

function sumarPunto() {
    puntos++;
    document.getElementById('puntos').innerText = puntos;
    // En niveles 1, 2, 3 pasa por puntos. En el 4 no.
    if(nivel < 4 && puntos >= 10) {
        nivel++; puntos = 0;
        alert("¬°Nivel Superado!");
        prepararNivel();
    }
}

function prepararNivel() {
    frame = 0; camX = 0; items = []; enemigos = [];
    document.getElementById('lvl-tag').innerText = "Nivel " + nivel;
    document.getElementById('puntos').innerText = puntos;

    if(nivel === 1) { // RITMO
        jugador.x = 50; jugador.y = canvas.height-110;
    } else if(nivel === 2) { // SURVIVOR
        jugador.x = canvas.width/2; jugador.y = canvas.height/2;
    } else if(nivel === 3) { // PACMAN
        jugador.x = 60; jugador.y = 60;
    } else if(nivel === 4) { // MARIO STYLE
        jugador.x = 100; jugador.y = canvas.height - 150;
        // Colocar donas a lo largo del camino
        for(let i=0; i<15; i++) {
            items.push({x: 500 + i*400, y: canvas.height - 150 - (Math.random()*150), t:'d'});
        }
        // Flanders y latas
        for(let i=0; i<5; i++) {
            enemigos.push({x: 800 + i*700, y: canvas.height - 100, t:'f'});
        }
    }
}

// MOTORES
function motorNivel4() {
    ctx.fillStyle = "#4da6ff"; ctx.fillRect(0,0,canvas.width, canvas.height);
    
    // Suelo
    ctx.fillStyle = "#8B4513"; ctx.fillRect(0, canvas.height-50, canvas.width, 50);
    ctx.fillStyle = "#228B22"; ctx.fillRect(0, canvas.height-65, canvas.width, 15);

    // Movimiento Homero (Velocidad Fija 5)
    jugador.x += jugador.dir * 5;
    jugador.vy += 0.6; // Gravedad
    jugador.y += jugador.vy;

    if(jugador.y > canvas.height - 115) {
        jugador.y = canvas.height - 115;
        jugador.vy = 0;
        jugador.saltos = 0;
    }

    // C√°mara sigue a Homero
    camX = jugador.x - 150;
    ctx.save();
    ctx.translate(-camX, 0);

    // Dibujar Donas
    items.forEach((it, i) => {
        ctx.font = "30px Arial"; ctx.fillText("üç©", it.x, it.y);
        if(Math.hypot(jugador.x - it.x, jugador.y - it.y) < 40) { items.splice(i,1); sumarPunto(); }
    });

    // Dibujar Enemigos (Flanders)
    enemigos.forEach(e => {
        ctx.font = "40px Arial"; ctx.fillText("üë®‚Äçüè´", e.x, e.y);
        if(Math.hypot(jugador.x - e.x, jugador.y - e.y) < 40) reiniciar();
    });

    // META: La Casa de los Simpson (a los 5000 pixeles)
    let metaX = 5000;
    ctx.fillStyle = "#ffcccc"; ctx.fillRect(metaX, canvas.height-250, 200, 200); // Casa
    ctx.fillStyle = "#8B4513"; ctx.fillRect(metaX+70, canvas.height-130, 60, 80); // Puerta
    ctx.font = "40px Arial"; 
    ctx.fillText("üë©‚Äçü¶±", metaX+150, canvas.height-70); // Marge
    ctx.fillText("üßí", metaX+190, canvas.height-70); // Bart
    ctx.font = "15px Arial"; ctx.fillStyle="white";
    ctx.fillText("HOGAR DULCE HOGAR", metaX+40, canvas.height-260);

    if(jugador.x > metaX + 100) {
        nivel++;
        alert("¬°Llegaste a casa! ¬°Woo-hoo!");
        prepararNivel();
    }

    ctx.restore();
    ctx.fillStyle = "yellow"; ctx.fillRect(150, jugador.y, 40, 50); // Homero est√°tico en pantalla x=150
}

// Motores anteriores (simplificados para que no pesen)
function motorRitmo() {
    ctx.fillStyle = "#1a1a2e"; ctx.fillRect(0,0,canvas.width, canvas.height);
    jugador.vy += 0.7; jugador.y += jugador.vy;
    if(jugador.y > canvas.height-110) { jugador.y = canvas.height-110; jugador.vy = 0; jugador.saltos = 0; }
    if(frame % 150 === 0) items.push({x: canvas.width, y: canvas.height-95, t: 'c'});
    items.forEach((it, i) => {
        it.x -= 4; ctx.font = "40px Arial"; ctx.fillText(it.t === 'c' ? "üåµ" : "üç©", it.x, it.y);
        if (Math.hypot(jugador.x - it.x, jugador.y - it.y) < 40) { it.t === 'c' ? reiniciar() : (items.splice(i, 1), sumarPunto()); }
    });
    ctx.fillStyle = "yellow"; ctx.fillRect(jugador.x, jugador.y, 40, 50);
}

function loop() {
    frame++;
    if(nivel === 1) motorRitmo();
    else if(nivel === 4) motorNivel4();
    else {
        // Pantalla temporal para niveles 2 y 3 mientras pruebas el 4
        ctx.fillStyle = "black"; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = "white"; ctx.fillText("Nivel " + nivel + " en mantenimiento. Pulsa para saltar al 4", 20, 100);
        if(frame % 100 === 0 && nivel < 4) { nivel = 4; prepararNivel(); }
    }
    requestAnimationFrame(loop);
}

prepararNivel();
loop();
</script>
</body>
</html>
