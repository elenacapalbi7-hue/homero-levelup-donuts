<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Homer Dash - 5 Niveles Reales</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial Black', sans-serif; touch-action: none; }
        #game-wrap { position: relative; width: 100vw; height: 100vh; background: #050510; }
        canvas { display: block; width: 100%; height: 100%; }

        #hud { position: absolute; top: 40px; width: 100%; display: flex; justify-content: space-around; 
               color: #FFD700; font-size: 20px; z-index: 10; pointer-events: none; text-shadow: 2px 2px #000; }

        #action-btn { 
            position: absolute; bottom: 240px; right: 40px; 
            width: 100px; height: 100px; background: rgba(255, 215, 0, 0.3); 
            border: 4px solid #FFD700; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 40px; z-index: 100; touch-action: none;
        }

        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                   background: rgba(0,0,0,0.9); display: flex; flex-direction: column; 
                   justify-content: center; align-items: center; color: white; z-index: 200; text-align: center; }
        .start-btn { padding: 18px 50px; font-size: 22px; background: #FFD700; border: none; border-radius: 12px; font-weight: bold; color: black; }
    </style>
</head>
<body>

<div id="game-wrap">
    <div id="hud">
        <div>NIVEL: <span id="txt-lvl">1</span></div>
        <div>üç©: <span id="txt-donuts">0</span>/10</div>
        <div>‚ù§Ô∏è: <span id="txt-lives">3</span></div>
    </div>

    <canvas id="screen"></canvas>
    <div id="action-btn">‚¨ÜÔ∏è</div>

    <div id="overlay">
        <h1 id="m-title">HOMER DASH</h1>
        <p id="m-desc">Iniciando aventura...</p>
        <button class="start-btn" onclick="init()">EMPEZAR</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    
    let level = 1, donuts = 0, lives = 3, active = false, frame = 0;
    let player = { x: 50, y: 0, w: 40, h: 50, vy: 0, jumps: 0, g: 0.6, speed: 5 };
    let platforms = [], items = [], hazards = [];

    function setup() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', setup);
    setup();

    function createLevel(lvl) {
        donuts = 0; frame = 0;
        platforms = []; items = []; hazards = [];
        document.getElementById('txt-donuts').innerText = "0/10";
        document.getElementById('txt-lvl').innerText = lvl;
        
        player.x = 50; 
        player.y = canvas.height - 150; 
        player.vy = 0; 
        player.jumps = 0;

        // Definir mec√°nicas por nivel
        player.speed = 4 + (lvl * 0.7); // Sube velocidad cada nivel
        if(lvl === 3) player.g = 0.3; else player.g = 0.6; // Nivel 3: Gravedad baja

        // Generaci√≥n de 10 secciones √∫nicas (Donas infinitas)
        for(let i=1; i<15; i++) {
            spawnModule(i * 380);
        }
    }

    function spawnModule(xPos) {
        let py;
        // Diferentes dise√±os seg√∫n nivel
        if(level === 2) py = canvas.height - (180 + Math.random() * 250); // Desniveles locos
        else py = canvas.height - (160 + Math.random() * 100);

        let pw = 130 + Math.random() * 70;
        platforms.push({ x: xPos, y: py, w: pw, h: 30 });
        items.push({ x: xPos + pw/2 - 15, y: py - 50, w: 30, h: 30 });

        // Obst√°culos solo en niveles 4 y 5
        if(level >= 4 && Math.random() > 0.5) {
            hazards.push({ x: xPos + 180, y: canvas.height - 85, w: 40, h: 40 });
        }
    }

    function update() {
        if(!active) return;
        frame++;

        player.x += player.speed;
        player.vy += player.g;
        player.y += player.vy;

        // Suelo firme
        const groundY = canvas.height - 100;
        if(player.y + player.h > groundY) {
            player.y = groundY - player.h;
            player.vy = 0;
            player.jumps = 0;
        }

        // --- COLISIONES MEJORADAS ---
        platforms.forEach(p => {
            // Colisi√≥n superior (Pisar)
            if (player.x + player.w > p.x && player.x < p.x + p.w &&
                player.y + player.h > p.y && player.y + player.h < p.y + 20 && player.vy > 0) {
                player.y = p.y - player.h;
                player.vy = 0;
                player.jumps = 0;
            }
            // Colisi√≥n lateral (Frenar, no morir)
            if (player.x + player.w > p.x && player.x < p.x + 10 && 
                player.y + player.h > p.y + 5 && player.y < p.y + p.h - 5) {
                player.x = p.x - player.w;
            }
        });

        // Donas (Contacto exacto)
        items.forEach((it, i) => {
            if (player.x < it.x + it.w && player.x + player.w > it.x &&
                player.y < it.y + it.h && player.y + player.h > it.y) {
                donuts++;
                items.splice(i, 1);
                document.getElementById('txt-donuts').innerText = donuts + "/10";
                if(donuts >= 10) win();
            }
        });

        // Peligros
        hazards.forEach(h => {
            if (player.x < h.x + h.w && player.x + player.w > h.x &&
                player.y < h.y + h.h && player.y + player.h > h.y) die();
        });

        // Generar m√°s camino
        if(frame % 60 === 0) spawnModule(player.x + canvas.width);
    }

    function render() {
        // Fondos por nivel
        const backgrounds = ["#050510", "#100510", "#051005", "#0a0a0a", "#1a1a00"];
        ctx.fillStyle = backgrounds[(level-1)%5];
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.save();
        ctx.translate(-player.x + 50, 0);

        // Suelo visible
        ctx.fillStyle = "#222";
        ctx.fillRect(player.x - 200, canvas.height - 100, canvas.width + 2000, 100);
        ctx.fillStyle = "#FFD700";
        ctx.fillRect(player.x - 200, canvas.height - 102, canvas.width + 2000, 2);

        // Plataformas
        ctx.fillStyle = "#FFD700";
        platforms.forEach(p => {
            ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.strokeStyle = "#FFF"; ctx.strokeRect(p.x, p.y, p.w, p.h);
        });

        // Donas y Peligros
        ctx.font = "30px Arial";
        items.forEach(it => ctx.fillText("üç©", it.x, it.y + 25));
        hazards.forEach(h => ctx.fillText("üî•", h.x, h.y + 30));

        // Personaje
        ctx.font = "50px Arial";
        ctx.fillText("üèÉ‚Äç‚ôÇÔ∏è", player.x, player.y + 45);

        ctx.restore();
        
        if(active) {
            update();
            requestAnimationFrame(render);
        }
    }

    const actionBtn = document.getElementById('action-btn');
    const handleAction = (e) => {
        if(e) e.preventDefault();
        if(player.jumps < 2) {
            player.vy = -14;
            player.jumps++;
        }
    };
    actionBtn.addEventListener('touchstart', handleAction);

    function die() {
        active = false;
        lives--;
        document.getElementById('txt-lives').innerText = lives;
        document.getElementById('overlay').style.display = "flex";
        if(lives <= 0) {
            level = 1; lives = 3;
            document.getElementById('m-title').innerText = "GAME OVER";
            document.getElementById('m-desc').innerText = "Reiniciando desde Nivel 1";
        } else {
            document.getElementById('m-title').innerText = "¬°D'OH!";
            document.getElementById('m-desc').innerText = "Te quedan " + lives + " vidas.";
        }
    }

    function win() {
        active = false;
        if(level < 5) {
            level++;
            document.getElementById('m-title').innerText = "¬°NIVEL LOGRADO!";
            document.getElementById('m-desc').innerText = "Siguiente mec√°nica: Nivel " + level;
        } else {
            level = 1;
            document.getElementById('m-title').innerText = "¬°GRAN CAMPE√ìN!";
            document.getElementById('m-desc').innerText = "¬°Ganaste los 5 niveles!";
        }
        document.getElementById('overlay').style.display = "flex";
    }

    function init() {
        document.getElementById('overlay').style.display = "none";
        createLevel(level);
        active = true;
        render();
    }
</script>
</body>
</html>
