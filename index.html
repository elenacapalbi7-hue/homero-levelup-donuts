<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homer World: 1-1 Edition</title>
    <style>
        body { margin: 0; background: #5c94fc; overflow: hidden; touch-action: none; font-family: 'Arial', sans-serif; }
        #ui { position: absolute; top: 0; width: 100%; z-index: 10; pointer-events: none; color: white; text-shadow: 2px 2px #000; }
        .hud { display: flex; justify-content: space-around; padding: 10px; font-size: 1.2rem; }
        
        /* Controles visuales para evitar aceleraci√≥n por gestos */
        #controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; }
        .btn { width: 70px; height: 70px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; pointer-events: auto; user-select: none; }
        .d-pad { display: flex; gap: 10px; }
    </style>
</head>
<body>

<div id="ui">
    <div class="hud">
        <div>HOMERO<br><span id="puntos">000000</span></div>
        <div>DONAS<br>üç© x <span id="donasCount">0</span></div>
        <div>TIEMPO DUFF<br><span id="timer">--</span></div>
    </div>
</div>

<div id="controls">
    <div class="d-pad">
        <div class="btn" id="btnLeft">‚¨ÖÔ∏è</div>
        <div class="btn" id="btnRight">‚û°Ô∏è</div>
    </div>
    <div class="btn" id="btnJump">‚¨ÜÔ∏è</div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// --- F√çSICA Y CONFIGURACI√ìN ---
const GRAVEDAD = 0.8;
const VEL_MAX = 5;
const SALTO_FUERZA = -14;

let puntos = 0, donas = 0, frame = 0, camX = 0;
let bloques = [], enemigos = [], items = [], particulas = [];
let duffTimer = 0;

let h = { 
    x: 100, y: 0, w: 40, h: 60, 
    vx: 0, vy: 0, 
    saltosDisponibles: 2, 
    esGrande: false,
    dir: 1
};

// --- INPUTS ---
let keys = { left: false, right: false };

function setupControls() {
    const bL = document.getElementById('btnLeft');
    const bR = document.getElementById('btnRight');
    const bJ = document.getElementById('btnJump');

    bL.ontouchstart = () => keys.left = true;
    bL.ontouchend = () => keys.left = false;
    bR.ontouchstart = () => keys.right = true;
    bR.ontouchend = () => keys.right = false;
    bJ.ontouchstart = () => {
        if (h.saltosDisponibles > 0) {
            h.vy = SALTO_FUERZA;
            h.saltosDisponibles--;
        }
    };
}

function initNivel() {
    bloques = []; enemigos = []; items = []; camX = 0;
    h.x = 100; h.y = 100;
    
    // Suelo y Mapa (Inspirado en Mario 1-1)
    for(let i=0; i<300; i++) {
        if (!(i > 80 && i < 84)) { // Hueco
            bloques.push({x: i*40, y: canvas.height-40, t:'S'});
            bloques.push({x: i*40, y: canvas.height-80, t:'S'});
        }
        
        // Bloques con ? y Ladrillos
        if(i === 20) bloques.push({x: i*40, y: canvas.height-220, t:'?'});
        if(i === 25) bloques.push({x: i*40, y: canvas.height-220, t:'D'}); // Bloque Duff
        if(i > 30 && i < 35) bloques.push({x: i*40, y: canvas.height-220, t:'L'}); // Ladrillos rompibles
        
        // Donas sueltas
        if(i % 15 === 0 && i > 10) items.push({x: i*40, y: canvas.height-150, t:'üç©'});
    }
}

function update() {
    // Movimiento Horizontal (Sin aceleraci√≥n infinita)
    if (keys.left) { h.vx = -VEL_MAX; h.dir = -1; }
    else if (keys.right) { h.vx = VEL_MAX; h.dir = 1; }
    else { h.vx = 0; }

    h.vy += GRAVEDAD;
    h.x += h.vx;
    h.y += h.vy;

    // C√°mara
    if (h.x > camX + canvas.width/2) camX = h.x - canvas.width/2;

    // Duff Timer
    if (duffTimer > 0) {
        duffTimer--;
        h.h = 85; h.esGrande = true;
        document.getElementById('timer').innerText = Math.ceil(duffTimer/60) + "s";
    } else {
        h.h = 60; h.esGrande = false;
        document.getElementById('timer').innerText = "--";
    }

    // Colisiones
    bloques.forEach((b, index) => {
        if (h.x + h.w > b.x && h.x < b.x + 40 && h.y + h.h > b.y && h.y < b.y + 40) {
            // Suelo
            if (h.vy > 0 && h.y + h.h - h.vy <= b.y) {
                h.y = b.y - h.h; h.vy = 0; h.saltosDisponibles = 2;
            }
            // Techo (Choque de cabeza)
            else if (h.vy < 0 && h.y - h.vy >= b.y + 40) {
                h.y = b.y + 40; h.vy = 1;
                
                if (b.t === 'L' && h.esGrande) { 
                    bloques.splice(index, 1); // Romper bloque
                    puntos += 50;
                } else if (b.t === '?') {
                    b.t = 'Usado'; donas++; puntos += 100;
                } else if (b.t === 'D') {
                    b.t = 'Usado'; duffTimer = 900; // 15 seg
                }
            }
        }
    });

    // Recoger Donas
    items.forEach((it, i) => {
        if (h.x + h.w > it.x && h.x < it.x + 30 && h.y + h.h > it.y && h.y < it.y + 30) {
            items.splice(i, 1); donas++; puntos += 100;
        }
    });

    // Reset si cae
    if (h.y > canvas.height) initNivel();
}

function draw() {
    ctx.clearRect(0,0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camX, 0);

    // Bloques
    bloques.forEach(b => {
        ctx.fillStyle = b.t === 'S' || b.t === 'L' ? "#e76e33" : (b.t === 'Usado' ? "#7f8c8d" : "#f1c40f");
        ctx.fillRect(b.x, b.y, 40, 40);
        ctx.strokeStyle = "#000"; ctx.strokeRect(b.x, b.y, 40, 40);
        if(b.t === '?') { ctx.fillStyle="#fff"; ctx.fillText("?", b.x+15, b.y+25); }
        if(b.t === 'D') { ctx.fillText("üç∫", b.x+10, b.y+25); }
    });

    // Items
    items.forEach(it => { ctx.font = "30px Arial"; ctx.fillText(it.t, it.x, it.y); });

    // Homero (Cuerpo Completo)
    ctx.font = h.esGrande ? "80px Arial" : "55px Arial";
    // Efecto de caminar simple
    let bob = (keys.left || keys.right) ? Math.sin(frame*0.2)*5 : 0;
    ctx.fillText("üë®‚Äçü¶≤", h.x, h.y + h.h + bob);

    // FINAL: Casa Simpson
    if (h.x > 10000) {
        ctx.font = "100px Arial"; ctx.fillText("üè†", 10500, canvas.height-180);
        ctx.font = "50px Arial";
        ctx.fillText("üë©‚Äçü¶±", 10450, canvas.height-120); // Marge
        ctx.fillText("üë¶", 10650, canvas.height-120); // Bart
        ctx.fillText("üëß", 10700, canvas.height-120); // Lisa
        
        if (h.x > 10750) { alert("¬°Nivel Completado! Familia reunida."); initNivel(); }
    }

    ctx.restore();
    document.getElementById('puntos').innerText = String(puntos).padStart(6, '0');
    document.getElementById('donasCount').innerText = donas;
}

function loop() {
    frame++; update(); draw(); requestAnimationFrame(loop);
}

window.onload = () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    setupControls(); initNivel(); loop();
};
</script>
</body>
</html>
