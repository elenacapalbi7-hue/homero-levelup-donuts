<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Homer Odyssey - Kids & Dev Edition</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; touch-action: none; }
        #game-wrap { position: relative; width: 100vw; height: 100vh; background: #050510; }
        canvas { display: block; width: 100%; height: 100%; }

        #hud { position: absolute; top: 30px; width: 100%; display: flex; justify-content: space-around; 
               color: #FFD700; font-size: 22px; z-index: 10; pointer-events: none; text-shadow: 2px 2px #000; }

        #action-btn { 
            position: absolute; bottom: 15%; right: 10%; 
            width: 100px; height: 100px; background: rgba(255, 215, 0, 0.4); 
            border: 4px solid #FFD700; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 40px; z-index: 100; touch-action: none;
        }

        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                   background: rgba(0,0,0,0.85); display: flex; flex-direction: column; 
                   justify-content: center; align-items: center; color: white; z-index: 200; text-align: center; }
        .start-btn { padding: 15px 40px; font-size: 20px; background: #FFD700; border: none; border-radius: 10px; font-weight: bold; color: #000; }
    </style>
</head>
<body>

<div id="game-wrap">
    <div id="hud">
        <div>NIVEL: <span id="txt-lvl">1</span></div>
        <div>üç©: <span id="txt-donuts">0</span>/10</div>
        <div>‚ù§Ô∏è: <span id="txt-lives">3</span></div>
    </div>
    <canvas id="screen"></canvas>
    <div id="action-btn">‚¨ÜÔ∏è</div>
    <div id="overlay">
        <h1 id="m-title">HOMER DASH</h1>
        <p id="m-desc">¬°Atrapa las donas!</p>
        <button class="start-btn" onclick="init()">JUGAR</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    
    let level = 1, donuts = 0, lives = 3, active = false, frame = 0;
    let player = { x: 50, y: 0, w: 50, h: 60, vy: 0, jumps: 0, g: 0.7, speed: 6, side: 1 };
    let objects = [], particles = [];
    let isPressing = false;

    function setup() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', setup);
    setup();

    function createLevel(lvl) {
        donuts = 0; frame = 0; objects = []; particles = [];
        document.getElementById('txt-donuts').innerText = "0/10";
        document.getElementById('txt-lvl').innerText = lvl;
        
        player.x = 100; 
        player.y = canvas.height - 160; 
        player.vy = 0; player.jumps = 0; player.side = 1;
        player.w = 50; player.h = 60;
        player.speed = (lvl === 5) ? 8 : 6;

        document.getElementById('action-btn').innerText = ["", "‚¨ÜÔ∏è", "üçÑ", "üöÄ", "üîÑ", "üèÉ"][lvl];

        // Spawneo inicial controlado
        let startPos = (lvl === 3) ? 1500 : 800; 
        for(let i=0; i<15; i++) {
            spawnElement(startPos);
            startPos += 500;
        }
    }

    function spawnElement(x) {
        // DONAS DIN√ÅMICAS POR NIVEL
        let dY;
        if (level === 1) dY = (x % 1000 === 0) ? canvas.height - 300 : canvas.height - 180;
        else if (level === 3) dY = 150 + Math.random() * (canvas.height - 300);
        else if (level === 4) dY = (player.side === 1) ? canvas.height - 200 : 200;
        else dY = canvas.height - 200;

        objects.push({ x: x + 150, y: dY, w: 50, h: 50, type: 'donut' });

        if (level === 1) { 
            objects.push({ x: x, y: canvas.height - 155, w: 60, h: 55, type: 'spike' });
        } 
        else if (level === 2) { 
            // MUROS EN DIFERENTES LUGARES (Suelo y Flotantes)
            let wallH = 60 + Math.random() * 100;
            let wallY = (Math.random() > 0.5) ? canvas.height - 100 - wallH : canvas.height - 350 - wallH;
            objects.push({ x: x, y: wallY, w: 60, h: wallH, type: 'brick' });
        }
        else if (level === 3) { 
            let gap = 300; // Gap m√°s grande para ni√±os
            let topH = 50 + Math.random() * 200;
            objects.push({ x: x, y: 0, w: 60, h: topH, type: 'hazard' });
            objects.push({ x: x, y: topH + gap, w: 60, h: canvas.height, type: 'hazard' });
        }
        else if (level === 4) { 
            // Nivel 4 m√°s f√°cil: Distancia doble entre obst√°culos
            objects.push({ x: x, y: (Math.random() > 0.5) ? canvas.height - 160 : 100, w: 60, h: 60, type: 'hazard' });
        }
        else if (level === 5) { 
            objects.push({ x: x, y: canvas.height - 160, w: 40, h: 60, type: 'hazard' });
        }
    }

    function createExplosion(x, y) {
        for(let i=0; i<8; i++) {
            particles.push({ x: x, y: y, vx: (Math.random()-0.5)*10, vy: (Math.random()-1)*10, size: 6, life: 30 });
        }
    }

    function update() {
        if(!active) return;
        frame++;
        player.x += player.speed;

        if(level === 2) {
            // CRECIMIENTO CONTINUO MIENTRAS PRESIONA
            if(isPressing) {
                player.w += 1.5; player.h += 1.8;
            } else {
                if(player.w > 50) { player.w -= 4; player.h -= 4.8; }
                if(player.w < 50) { player.w = 50; player.h = 60; }
            }
            player.y = (canvas.height - 100) - player.h;
        } else if (level === 3) { 
            if(isPressing) player.vy = -6; else player.vy += 0.4;
            player.y += player.vy;
        } else if (level === 4) { 
            player.vy += (0.5 * player.side); // Gravedad m√°s suave
            player.y += player.vy;
        } else { 
            player.vy += player.g; player.y += player.vy;
        }

        // Suelo firme
        const groundLimit = canvas.height - 100;
        if (level !== 4) {
            if (player.y + player.h > groundLimit) {
                player.y = groundLimit - player.h; player.vy = 0; player.jumps = 0;
            }
        }
        if (player.y < 0) { player.y = 0; player.vy = 0; }

        objects.forEach((obj, i) => {
            if (player.x < obj.x + obj.w && player.x + player.w > obj.x &&
                player.y < obj.y + obj.h && player.y + player.h > obj.y) {
                
                if (obj.type === 'donut') {
                    donuts++; objects.splice(i, 1);
                    document.getElementById('txt-donuts').innerText = donuts + "/10";
                    if(donuts >= 10) win();
                } else if (obj.type === 'brick' && player.w > 80) {
                    createExplosion(obj.x, obj.y); objects.splice(i, 1);
                } else { die(); }
            }
        });

        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.vy += 0.4; p.life--;
            if(p.life <= 0) particles.splice(i, 1);
        });

        if (frame % 60 === 0) {
            let lastX = objects.length > 0 ? objects[objects.length-1].x : player.x + 500;
            spawnElement(lastX + 500);
        }
    }

    function render() {
        ctx.fillStyle = ["#050510", "#1a0505", "#051a05", "#05051a", "#1a1a00"][level-1];
        ctx.fillRect(0,0,canvas.width, canvas.height);
        
        ctx.save();
        ctx.translate(-player.x + 100, 0);

        // SUELO SIEMPRE PRESENTE
        ctx.fillStyle = "#333";
        ctx.fillRect(player.x - 500, canvas.height - 100, canvas.width + 4000, 100);
        ctx.fillStyle = "#FFD700";
        ctx.fillRect(player.x - 500, canvas.height - 102, canvas.width + 4000, 3);
        if(level === 4) ctx.fillRect(player.x - 500, 100, canvas.width + 4000, 3);

        objects.forEach(obj => {
            if (obj.type === 'donut') {
                ctx.font = "50px Arial"; ctx.fillText("üç©", obj.x, obj.y + 40);
            } else if (obj.type === 'spike') {
                ctx.fillStyle = "#ff0000"; ctx.beginPath();
                ctx.moveTo(obj.x, obj.y + obj.h); ctx.lineTo(obj.x + obj.w/2, obj.y);
                ctx.lineTo(obj.x + obj.w, obj.y + obj.h); ctx.fill();
            } else if (obj.type === 'brick') {
                ctx.fillStyle = "#8B4513"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                ctx.strokeStyle = "white"; ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
            } else {
                ctx.fillStyle = "#ff4444"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            }
        });

        particles.forEach(p => { ctx.fillStyle = "#8B4513"; ctx.fillRect(p.x, p.y, p.size, p.size); });

        // JUGADOR
        ctx.save();
        let fontSize = Math.max(player.h, 40);
        if(level === 4 && player.side === -1) {
            ctx.translate(player.x + player.w/2, player.y + player.h/2); ctx.scale(1, -1);
            ctx.font = `${fontSize}px Arial`; ctx.fillText("üèÉ‚Äç‚ôÇÔ∏è", -player.w/2, player.h/2);
        } else {
            ctx.font = `${fontSize}px Arial`; ctx.fillText("üèÉ‚Äç‚ôÇÔ∏è", player.x, player.y + player.h - 5);
        }
        ctx.restore();
        ctx.restore();

        if(active) { update(); requestAnimationFrame(render); }
    }

    const btn = document.getElementById('action-btn');
    const startAction = (e) => { 
        e.preventDefault(); isPressing = true; 
        if ((level === 1 || level === 5) && player.jumps < 2) { player.vy = -16; player.jumps++; }
        if (level === 4) { player.side *= -1; player.vy = 0; }
    };
    const endAction = (e) => { e.preventDefault(); isPressing = false; };
    btn.addEventListener('touchstart', startAction); btn.addEventListener('touchend', endAction);
    btn.addEventListener('mousedown', startAction); btn.addEventListener('mouseup', endAction);

    function die() {
        active = false; lives--; document.getElementById('txt-lives').innerText = lives;
        document.getElementById('overlay').style.display = "flex";
        if(lives <= 0) { level = 1; lives = 3; document.getElementById('m-title').innerText = "FIN DEL JUEGO"; }
        else { document.getElementById('m-title').innerText = "¬°D'OH!"; }
    }

    function win() {
        active = false; level++; if(level > 5) level = 1;
        document.getElementById('m-title').innerText = "¬°NIVEL LOGRADO!";
        document.getElementById('overlay').style.display = "flex";
    }

    function init() { document.getElementById('overlay').style.display = "none"; createLevel(level); active = true; render(); }
</script>
</body>
</html>
