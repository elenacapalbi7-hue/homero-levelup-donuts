<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homero: Springfield Quest</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; image-rendering: pixelated; }
        
        /* HUD Estilo Mario */
        #ui { position: absolute; top: 0; width: 100%; pointer-events: none; z-index: 100; }
        .hud { 
            background: #e74c3c; 
            color: white; 
            padding: 10px; 
            display: flex; 
            justify-content: space-around; 
            font-family: monospace; 
            font-weight: bold;
            font-size: 1.2rem;
            border-bottom: 4px solid #c0392b;
        }
    </style>
</head>
<body>

<div id="ui">
    <div class="hud">
        <span>DONAS: <span id="puntos">000000</span></span>
        <span>VIDAS: <span id="vidas">3</span></span>
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// Variables de estado
let nivel = 1;
let puntos = 0;
let vidas = 3;
let frame = 0;
let items = [];
let enemigos = [];
let camX = 0;

// Configuraci√≥n de Homero
let jugador = {
    x: 50, y: 0, w: 40, h: 60,
    vy: 0, saltos: 0, dirX: 0,
    velocidad: 5
};

// --- CONTROLES (VELOCIDAD FIJA) ---
let tStartX = 0;
window.addEventListener('touchstart', e => {
    tStartX = e.touches[0].clientX;
    // Salto
    if (jugador.saltos < 2) {
        jugador.vy = -12;
        jugador.saltos++;
    }
});

window.addEventListener('touchmove', e => {
    e.preventDefault();
    let dx = e.touches[0].clientX - tStartX;
    // Movimiento lateral sin aceleraci√≥n
    if (dx > 30) jugador.dirX = 1;
    else if (dx < -30) jugador.dirX = -1;
    else jugador.dirX = 0;
}, {passive: false});

window.addEventListener('touchend', () => {
    jugador.dirX = 0;
});

// --- L√ìGICA DE NIVELES ---

function prepararNivel() {
    items = [];
    enemigos = [];
    frame = 0;
    camX = 0;
    jugador.vy = 0;
    jugador.saltos = 0;
    
    document.getElementById('vidas').innerText = vidas;

    if (nivel === 1) {
        jugador.x = 50;
        jugador.y = canvas.height - 120;
    } else if (nivel === 4) {
        jugador.x = 100;
        // Generar algunas donas y Flanders en el camino largo
        for(let i=0; i<20; i++) {
            items.push({x: 600 + (i * 400), y: canvas.height - 200, t: 'd'});
            if(i % 3 === 0) enemigos.push({x: 800 + (i * 400), y: canvas.height - 100});
        }
    }
}

function sumarPunto() {
    puntos++;
    document.getElementById('puntos').innerText = String(puntos).padStart(6, '0');
    if (nivel < 4 && puntos >= 10) {
        nivel++;
        puntos = 0;
        prepararNivel();
    }
}

function morir() {
    vidas--;
    if (vidas <= 0) {
        alert("GAME OVER");
        nivel = 1;
        vidas = 3;
    }
    puntos = 0;
    prepararNivel();
}

// --- MOTORES GR√ÅFICOS ---

function dibujarSueloMario(xOffset) {
    let size = 40;
    ctx.fillStyle = "#d35400"; // Color ladrillo
    for (let i = 0; i < canvas.width + size; i += size) {
        let drawX = (i - (xOffset % size));
        ctx.fillRect(drawX, canvas.height - size, size - 2, size - 2);
    }
}

function motorNivel1() {
    // Fondo Desierto
    ctx.fillStyle = "#f1c40f"; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Gravedad
    jugador.vy += 0.8;
    jugador.y += jugador.vy;
    if (jugador.y > canvas.height - 100) {
        jugador.y = canvas.height - 100;
        jugador.vy = 0;
        jugador.saltos = 0;
    }

    // Generar obst√°culos
    if (frame % 100 === 0) items.push({x: canvas.width, y: canvas.height - 100, t: 'c'});
    
    // Dibujar y mover items
    items.forEach((it, i) => {
        it.x -= 6; 
        ctx.font = "40px Arial";
        ctx.fillText(it.t === 'c' ? "üåµ" : "üç©", it.x, it.y);
        
        // Colisi√≥n
        if (Math.hypot(jugador.x - it.x, jugador.y - it.y) < 40) {
            if (it.t === 'c') morir();
            else { items.splice(i, 1); sumarPunto(); }
        }
    });

    // Homero
    ctx.font = "50px Arial";
    ctx.fillText("üë®‚Äçü¶≤", jugador.x, jugador.y);
}

function motorNivel4() {
    // Cielo Mario
    ctx.fillStyle = "#5c94fc"; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Movimiento y C√°mara
    jugador.x += jugador.dirX * jugador.velocidad;
    camX = jugador.x - 100;

    // Gravedad
    jugador.vy += 0.8;
    jugador.y += jugador.vy;
    if (jugador.y > canvas.height - 100) {
        jugador.y = canvas.height - 100;
        jugador.vy = 0;
        jugador.saltos = 0;
    }

    ctx.save();
    ctx.translate(-camX, 0);

    // Dibujar Suelo Ladrillo
    dibujarSueloMario(camX);

    // Decoraci√≥n (Monta√±as y Nubes)
    ctx.font = "100px Arial";
    ctx.fillText("‚òÅÔ∏è", 200, 150);
    ctx.fillText("‚õ∞Ô∏è", 400, canvas.height - 100);

    // Items y Enemigos
    items.forEach((it, i) => {
        ctx.font = "40px Arial";
        ctx.fillText("üç©", it.x, it.y);
        if (Math.hypot(jugador.x - it.x, jugador.y - it.y) < 40) {
            items.splice(i, 1);
            sumarPunto();
        }
    });

    enemigos.forEach(en => {
        ctx.font = "45px Arial";
        ctx.fillText("üë®‚Äçüè´", en.x, en.y); // Flanders
        if (Math.hypot(jugador.x - en.x, jugador.y - en.y) < 40) morir();
    });

    // Meta final (Casa de Homero)
    let metaX = 5000;
    ctx.font = "150px Arial";
    ctx.fillText("üè†", metaX, canvas.height - 100);
    ctx.font = "50px Arial";
    ctx.fillText("üë©‚Äçü¶±", metaX + 160, canvas.height - 60); // Marge esper√°ndolo

    if (jugador.x > metaX + 100) {
        alert("¬°GANASTE! Llegaste a casa.");
        nivel = 1;
        prepararNivel();
    }

    ctx.restore();

    // Homero fijo en relaci√≥n a la c√°mara
    ctx.font = "50px Arial";
    ctx.fillText("üë®‚Äçü¶≤", 100, jugador.y);
}

// Bucle principal
function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    frame++;

    if (nivel === 1) motorNivel1();
    else if (nivel === 4) motorNivel4();
    else {
        // Pantalla de carga para niveles intermedios (2 y 3)
        ctx.fillStyle = "black";
        ctx.fillRect(0,0, canvas.width, canvas.height);
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.fillText("NIVEL " + nivel + " - Pulsa para avanzar", canvas.width/2, canvas.height/2);
    }

    requestAnimationFrame(loop);
}

// Iniciar
window.onload = () => {
    resize();
    prepararNivel();
    loop();
};

// Si haces clic en la pantalla de carga, avanza de nivel
window.addEventListener('click', () => {
    if (nivel > 1 && nivel < 4) {
        nivel++;
        prepararNivel();
    }
});

</script>
</body>
</html>
